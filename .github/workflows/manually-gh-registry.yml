name: manually-gh-registry
on:
  workflow_dispatch:
    inputs:
      to_push:
        description: 'push the built container'
        required: true
        default: false
        type: boolean
env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
jobs:
  build:
    runs-on: ubuntu-20.04
    if: github.repository == 'falgon/roki-web'
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        submodules: true
    - name: Setup environment variables
      run: |
        ENV_IMAGE_NAME=$(cat ./docker/.env | grep ROKI_WEB_ENV_IMAGE_NAME | cut -f2 -d=)
        DEV_IMAGE_NAME=$(cat ./docker/.env | grep ROKI_WEB_DEV_IMAGE_NAME | cut -f2 -d=)
        echo "ENV_IMAGE_NAME=$ENV_IMAGE_NAME" >> $GITHUB_ENV
        echo "DEV_IMAGE_NAME=$DEV_IMAGE_NAME" >> $GITHUB_ENV
        VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
        [[ "${{ github.ref }}" = "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')
        IMAGE_TAG=$(test $VERSION = master && echo latest || echo $VERSION)
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
        echo "ENV_GH_REGISTRY=docker.pkg.github.com/${{ github.repository }}/$(echo $ENV_IMAGE_NAME | cut -f2 -d/):$IMAGE_TAG" >> $GITHUB_ENV
        echo "DEV_GH_REGISTRY=docker.pkg.github.com/${{ github.repository }}/$(echo $DEV_IMAGE_NAME | cut -f2 -d/):$IMAGE_TAG" >> $GITHUB_ENV
    - name: Login GitHub Registry
      if: ${{ github.event.inputs.to_push }}
      run: echo ${{ secrets.GITHUB_TOKEN }} | docker login docker.pkg.github.com -u owner --password-stdin
    - name: Build Image
      shell: bash
      run: |
        ROKI_WEB_ENV_IMAGE_TAG=$IMAGE_TAG ROKI_WEB_DEV_IMAGE_TAG=$IMAGE_TAG pushd ./docker && \
          docker-compose build --no-cache preview dev; \
        popd
        docker save $ENV_IMAGE_NAME > /tmp/env_img.tar
        docker save $DEV_IMAGE_NAME > /tmp/dev_img.tar
    - name: Upload env image
      uses: actions/upload-artifact@v2
      with:
        name: env_img
        path: /tmp/env_img.tar
    - name: Upload dev image
      uses: actions/upload-artifact@v2
      with:
        name: dev_img
        path: /tmp/dev_img.tar
  push:
    runs-on: ubuntu-20.04
    needs: build
    if: ${{ github.event.inputs.to_push }}
    steps:
    - name: Download env image
      uses: actions/download-artifact@v2
      with:
        name: env_img
        path: /tmp
    - name: Download dev image
      uses: actions/download-artifact@v2
      with:
        name: dev_img
        path: /tmp
    - name: Load images
      shell: bash
      run: |
        docker load --input /tmp/env_img.tar
        docker load --input /tmp/dev_img.tar
    - name: Push to GitHub Package Registry
      shell: bash
      run: |
        docker tag $ENV_IMAGE_NAME $ENV_GH_REGISTRY
        docker tag $DEV_IMAGE_NAME $DEV_GH_REGISTRY
        docker push $ENV_GH_REGISTRY
        docker push $DEV_GH_REGISTRY
