name: CI

on:
  push:
    branches:
        - develop
        - master
  pull_request:
    branches:
        - develop
        - master
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
          submodules: true
    - uses: actions/setup-haskell@v1.1.2
      with:
        ghc-version: '8.8.3'
        enable-stack: latest
    - uses: actions/setup-node@v1
      with:
          node-version: '14'
    - name: Cache
      uses: actions/cache@v2
      id: stack-cache
      with:
          path: ~/.stack
          key: stack-v2-${{ runner.os }}-${{ hashFiles('stack.yaml') }}
    - name: Setup Stack
      if: steps.stack-cache.outputs.cache-hit != 'true'
      run: |
        stack config set system-ghc --global true
        stack config set install-ghc --global false
    - name: Install dependencies and build the site generator
    - run: |
        stack --local-bin-path . install --flag hakyll:-previewServer --flag hakyll:-watchServer
        npm ci
    - name: Build site
      run: |
        ./site build
        ./site check --internal-links
    - name: Upload artifact
      uses: actions/upload-artifact@v2
      with:
          name: blog
          path: build.tar.xz
