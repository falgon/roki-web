import{beforeEach,describe,expect,it}from"vitest";import"../disney-tag-filter";describe("disney-tag-filter.ts",()=>{beforeEach(()=>{document.body.innerHTML=""}),describe("escapeHtml",()=>{it("escapes HTML special characters",()=>{expect(escapeHtml("<script>alert('xss')<\/script>")).toBe("&lt;script&gt;alert('xss')&lt;/script&gt;")}),it("escapes ampersands",()=>{expect(escapeHtml("Tom & Jerry")).toBe("Tom &amp; Jerry")}),it("does not escape quotes when using textContent",()=>{expect(escapeHtml('"Hello World"')).toBe('"Hello World"')}),it("does not escape single quotes",()=>{expect(escapeHtml("It's a test")).toBe("It's a test")}),it("handles multiple special characters",()=>{expect(escapeHtml('<div class="test">A & B</div>')).toBe('&lt;div class="test"&gt;A &amp; B&lt;/div&gt;')}),it("handles empty string",()=>{expect(escapeHtml("")).toBe("")}),it("handles normal text without special characters",()=>{expect(escapeHtml("Hello World")).toBe("Hello World")}),it("handles newlines and spaces",()=>{expect(escapeHtml("Line 1\nLine 2")).toBe("Line 1\nLine 2")})}),describe("DOM structure",()=>{it("can create loading overlay structure",()=>{document.body.innerHTML='\n                <div id="loading-overlay"></div>\n                <div id="main-content"></div>\n                <div id="progress-bar"></div>\n                <div id="progress-text"></div>\n                <div id="loading-details"></div>\n            ';const t=document.getElementById("loading-overlay"),e=document.getElementById("main-content"),n=document.getElementById("progress-bar"),a=document.getElementById("progress-text"),i=document.getElementById("loading-details");expect(t).toBeTruthy(),expect(e).toBeTruthy(),expect(n).toBeTruthy(),expect(a).toBeTruthy(),expect(i).toBeTruthy()}),it("can create tag filter structure",()=>{document.body.innerHTML='\n                <div id="tag-filters">\n                    <button class="tag-filter-button" data-tag="tag1">Tag 1</button>\n                    <button class="tag-filter-button" data-tag="tag2">Tag 2</button>\n                </div>\n                <div id="selected-tags-list"></div>\n                <button id="clear-selection">Clear</button>\n                <div class="log-entry" data-tags="tag1,tag2">Entry 1</div>\n                <div class="log-entry" data-tags="tag2">Entry 2</div>\n            ';const t=document.getElementById("tag-filters"),e=document.querySelectorAll(".tag-filter-button"),n=document.getElementById("clear-selection"),a=document.querySelectorAll(".log-entry");expect(t).toBeTruthy(),expect(e.length).toBe(2),expect(n).toBeTruthy(),expect(a.length).toBe(2)})}),describe("tag filtering logic",()=>{beforeEach(()=>{document.body.innerHTML='\n                <div class="log-entry" data-tags="tag1,tag2">Entry 1</div>\n                <div class="log-entry" data-tags="tag2,tag3">Entry 2</div>\n                <div class="log-entry" data-tags="tag1">Entry 3</div>\n            '}),it("filters entries by single tag",()=>{const t=document.querySelectorAll(".log-entry"),e=Array.from(t).filter(t=>{const e=t.getAttribute("data-tags");return e?.includes("tag1")});expect(e.length).toBe(2)}),it("filters entries by multiple tags (AND condition)",()=>{const t=document.querySelectorAll(".log-entry"),e=["tag1","tag2"],n=Array.from(t).filter(t=>{const n=t.getAttribute("data-tags");if(!n)return!1;const a=n.split(",").map(t=>t.trim());return e.every(t=>a.includes(t))});expect(n.length).toBe(1)})}),describe("normalizeString",()=>{it("converts to lowercase",()=>{expect(normalizeString("HELLO WORLD")).toBe("hello world")}),it("trims whitespace",()=>{expect(normalizeString("  hello  ")).toBe("hello")}),it("handles empty string",()=>{expect(normalizeString("")).toBe("")}),it("handles mixed case with whitespace",()=>{expect(normalizeString("  Hello World  ")).toBe("hello world")})}),describe("search filtering logic",()=>{beforeEach(()=>{document.body.innerHTML='\n                <div class="log-entry" data-tags="tag1" data-search-content="Beautiful sunset at Tokyo DisneySea">Entry 1</div>\n                <div class="log-entry" data-tags="tag2" data-search-content="Magic Kingdom parade was amazing">Entry 2</div>\n                <div class="log-entry" data-tags="tag1,tag2" data-search-content="DisneySea Special Event">Entry 3</div>\n            '}),it("filters entries by partial match search",()=>{const t=document.querySelectorAll(".log-entry"),e=Array.from(t).filter(t=>{const e=t.getAttribute("data-search-content");return!!e&&e.toLowerCase().includes("disneysea")});expect(e.length).toBe(2)}),it("combines tag filter and search (AND condition)",()=>{const t=document.querySelectorAll(".log-entry"),e=["tag1"],n=Array.from(t).filter(t=>{const n=t.getAttribute("data-tags"),a=t.getAttribute("data-search-content");if(!n||!a)return!1;const i=n.split(",").map(t=>t.trim()),s=e.every(t=>i.includes(t)),r=a.toLowerCase().includes("disneysea");return s&&r});expect(n.length).toBe(2)}),it("returns all entries when search is empty",()=>{const t=document.querySelectorAll(".log-entry"),e=Array.from(t).filter(t=>{t.getAttribute("data-search-content");return!0});expect(e.length).toBe(3)}),it("returns no entries when search matches nothing",()=>{const t=document.querySelectorAll(".log-entry"),e=Array.from(t).filter(t=>{const e=t.getAttribute("data-search-content");return!!e&&e.toLowerCase().includes("nonexistent")});expect(e.length).toBe(0)}),it("handles case-insensitive search",()=>{const t=document.querySelectorAll(".log-entry"),e=Array.from(t).filter(t=>{const e=t.getAttribute("data-search-content");return!!e&&e.toLowerCase().includes("DISNEYSEA".toLowerCase())});expect(e.length).toBe(2)})}),describe("search filter toggle",()=>{beforeEach(()=>{document.body.innerHTML='\n                <button id="toggle-search-filter" aria-expanded="false" aria-controls="search-filter">キーワード検索</button>\n                <div class="search-filter" id="search-filter" style="display: none;">\n                    <input type="text" id="search-input" class="input" placeholder="検索..." />\n                </div>\n            '}),it("search filter toggle button exists",()=>{const t=document.getElementById("toggle-search-filter");expect(t).toBeTruthy(),expect(t?.getAttribute("aria-expanded")).toBe("false")}),it("search filter is initially hidden",()=>{const t=document.getElementById("search-filter");expect(t).toBeTruthy(),expect(t?.style.display).toBe("none")})}),describe("clear selection behavior",()=>{beforeEach(()=>{document.body.innerHTML='\n                <input type="text" id="search-input" class="input" placeholder="検索..." value="test query" />\n                <button class="tag-filter-btn active" data-tag="tag1">Tag 1</button>\n                <button class="tag-filter-btn active" data-tag="tag2">Tag 2</button>\n                <button id="clear-selection">クリア</button>\n                <div class="selected-tags"></div>\n                <div class="selected-tags-list"></div>\n            '}),it("search query is preserved after clear selection",()=>{const t=document.getElementById("search-input"),e="test query";t.value=e,expect(t.value).toBe(e)}),it("tag selections can be cleared independently",()=>{const t=document.querySelectorAll(".tag-filter-btn");expect(t.length).toBe(2),t.forEach(t=>{expect(t.classList.contains("active")).toBe(!0)})})}),describe("space-separated keyword search",()=>{beforeEach(()=>{document.body.innerHTML='\n                <div class="log-entry" data-tags="tag1" data-search-content="Tokyo DisneySea Magic">Entry 1</div>\n                <div class="log-entry" data-tags="tag2" data-search-content="Disney Magic Kingdom">Entry 2</div>\n                <div class="log-entry" data-tags="tag1,tag2" data-search-content="Tokyo DisneySea Special Event">Entry 3</div>\n                <div class="log-entry" data-tags="tag3" data-search-content="Universal Studios Japan">Entry 4</div>\n            '}),it("filters entries with single keyword",()=>{const t=document.querySelectorAll(".log-entry"),e=Array.from(t).filter(t=>{const e=t.getAttribute("data-search-content");if(!e)return!1;const n=normalizeString(e),a=normalizeString("tokyo");return n.includes(a)});expect(e.length).toBe(2)}),it("filters entries with multiple keywords (AND condition)",()=>{const t=document.querySelectorAll(".log-entry"),e=Array.from(t).filter(t=>{const e=t.getAttribute("data-search-content");if(!e)return!1;const n=normalizeString(e);return normalizeString("tokyo disneysea").split(/\s+/).filter(t=>t.length>0).every(t=>n.includes(t))});expect(e.length).toBe(2)}),it("filters entries with three or more keywords",()=>{const t=document.querySelectorAll(".log-entry"),e=Array.from(t).filter(t=>{const e=t.getAttribute("data-search-content");if(!e)return!1;const n=normalizeString(e);return normalizeString("tokyo disneysea special").split(/\s+/).filter(t=>t.length>0).every(t=>n.includes(t))});expect(e.length).toBe(1)}),it("handles case-insensitive multi-keyword search",()=>{const t=document.querySelectorAll(".log-entry"),e=Array.from(t).filter(t=>{const e=t.getAttribute("data-search-content");if(!e)return!1;const n=normalizeString(e);return normalizeString("TOKYO DisneySea").split(/\s+/).filter(t=>t.length>0).every(t=>n.includes(t))});expect(e.length).toBe(2)}),it("returns no entries when no keywords match",()=>{const t=document.querySelectorAll(".log-entry"),e=Array.from(t).filter(t=>{const e=t.getAttribute("data-search-content");if(!e)return!1;const n=normalizeString(e);return normalizeString("nonexistent keyword").split(/\s+/).filter(t=>t.length>0).every(t=>n.includes(t))});expect(e.length).toBe(0)})}),describe("integration tests",()=>{beforeEach(()=>{document.body.innerHTML='\n                <div id="loading-overlay"></div>\n                <div id="main-content"></div>\n                <div id="progress-bar"></div>\n                <div id="progress-text"></div>\n                <div id="loading-details"></div>\n                <input type="text" id="search-input" class="input" placeholder="検索..." />\n                <div class="log-entry" data-tags="tag1" data-search-content="Tokyo DisneySea Magic">Entry 1</div>\n                <div class="log-entry" data-tags="tag2" data-search-content="Disney Magic Kingdom">Entry 2</div>\n                <div class="log-entry" data-tags="tag1,tag2" data-search-content="Special Event">Entry 3</div>\n            '}),it("should filter entries when user types in search input",t=>{const e=document.getElementById("search-input"),n=document.querySelectorAll(".log-entry");expect(e).toBeTruthy(),expect(n.length).toBe(3),e.value="disney";const a=new Event("input",{bubbles:!0});e.dispatchEvent(a),setTimeout(()=>{expect(e.value).toBe("disney"),t()},350)}),it("should handle multiple rapid inputs with debounce",t=>{const e=document.getElementById("search-input");expect(e).toBeTruthy(),e.value="d",e.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout(()=>{e.value="di",e.dispatchEvent(new Event("input",{bubbles:!0}))},50),setTimeout(()=>{e.value="dis",e.dispatchEvent(new Event("input",{bubbles:!0}))},100),setTimeout(()=>{e.value="disney",e.dispatchEvent(new Event("input",{bubbles:!0}))},150),setTimeout(()=>{expect(e.value).toBe("disney"),t()},500)}),it("should normalize search queries correctly",()=>{const t=normalizeString("DISNEY");expect(t).toBe("disney");const e=normalizeString("  Disney  ");expect(e).toBe("disney");const n=normalizeString("  TOKYO DisneySea  ");expect(n).toBe("tokyo disneysea")}),it("should handle empty search input",t=>{const e=document.getElementById("search-input");expect(e).toBeTruthy(),e.value="";const n=new Event("input",{bubbles:!0});e.dispatchEvent(n),setTimeout(()=>{expect(e.value).toBe(""),t()},350)}),it("should verify search input element exists",()=>{const t=document.getElementById("search-input");expect(t).toBeTruthy(),expect(t?.getAttribute("placeholder")).toBe("検索...")}),it("should add active class to tag button when clicked",()=>{document.body.innerHTML='\n                <button class="tag-filter-btn is-outlined" data-tag="tag1">Tag 1</button>\n                <button class="tag-filter-btn is-outlined" data-tag="tag2">Tag 2</button>\n            ';const t=document.querySelector('[data-tag="tag1"]');expect(t).toBeTruthy(),expect(t?.classList.contains("is-outlined")).toBe(!0),expect(t?.classList.contains("active")).toBe(!1),t?.classList.add("active"),t?.classList.remove("is-outlined"),expect(t?.classList.contains("active")).toBe(!0),expect(t?.classList.contains("is-outlined")).toBe(!1)}),it("should remove active class from all tag buttons after clear button click",()=>{document.body.innerHTML='\n                <button class="tag-filter-btn active" data-tag="tag1">Tag 1</button>\n                <button class="tag-filter-btn active" data-tag="tag2">Tag 2</button>\n                <button id="clear-selection">Clear</button>\n            ';const t=document.querySelectorAll(".tag-filter-btn");expect(t.length).toBe(2),t.forEach(t=>{expect(t.classList.contains("active")).toBe(!0)}),t.forEach(t=>{t.classList.remove("active"),t.classList.add("is-outlined")}),t.forEach(t=>{expect(t.classList.contains("active")).toBe(!1),expect(t.classList.contains("is-outlined")).toBe(!0)})}),it("should toggle search filter visibility correctly",()=>{document.body.innerHTML='\n                <button id="toggle-search-filter" class="is-outlined" aria-expanded="false">Toggle Search</button>\n                <div id="search-filter" style="display: none;">Search Filter Content</div>\n            ';const t=document.getElementById("toggle-search-filter"),e=document.getElementById("search-filter");expect(t).toBeTruthy(),expect(e).toBeTruthy(),expect(e?.style.display).toBe("none"),expect(t?.classList.contains("is-outlined")).toBe(!0),e&&(e.style.display="block"),t?.classList.remove("is-outlined"),t?.classList.add("is-info"),t?.setAttribute("aria-expanded","true"),expect(e?.style.display).toBe("block"),expect(t?.classList.contains("is-info")).toBe(!0),expect(t?.getAttribute("aria-expanded")).toBe("true"),e&&(e.style.display="none"),t?.classList.remove("is-info"),t?.classList.add("is-outlined"),t?.setAttribute("aria-expanded","false"),expect(e?.style.display).toBe("none"),expect(t?.classList.contains("is-outlined")).toBe(!0),expect(t?.getAttribute("aria-expanded")).toBe("false")})})});
