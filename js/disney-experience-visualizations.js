!function(){"use strict";class t{constructor(t){const e=document.querySelector(t);if(!e)throw new Error(`Tab list not found: ${t}`);this.tabs=Array.from(e.querySelectorAll('[role="tab"]')),this.panels=[],this.tabs.forEach(t=>{const e=t.getAttribute("aria-controls");if(e){const t=document.getElementById(e);t&&this.panels.push(t)}}),this.initCallbacks=new Map,this.initializedPanels=new Set,this.hashToPanelMap=new Map([["exp_list","panel-list"],["exp_timeline","panel-timeline"],["exp_tags","panel-tags"],["exp_hotels","panel-hotels"]]),this.setupEventListeners()}registerInitCallback(t,e){this.initCallbacks.set(t,e)}initialize(){this.initializeActiveTab()}setupEventListeners(){this.tabs.forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),this.switchToTab(t)}),t.addEventListener("keydown",e=>{this.handleKeyDown(e,t)})})}activateTabFromHash(){const t=window.location.hash.substring(1);if(!t)return!1;const e=this.hashToPanelMap.get(t);if(!e)return!1;const a=this.tabs.find(t=>t.getAttribute("aria-controls")===e);return!!a&&(this.switchToTab(a),!0)}initializeActiveTab(){if(this.activateTabFromHash())return;const t=this.tabs.find(t=>"true"===t.getAttribute("aria-selected"));if(t){const e=t.getAttribute("aria-controls");e&&this.initializePanelIfNeeded(e)}}switchToTab(t){this.tabs.forEach(t=>{t.setAttribute("aria-selected","false"),t.setAttribute("tabindex","-1"),t.parentElement?.classList.remove("is-active")}),t.setAttribute("aria-selected","true"),t.setAttribute("tabindex","0"),t.parentElement?.classList.add("is-active"),t.focus(),this.panels.forEach(t=>{t.classList.remove("is-active"),t.setAttribute("hidden","")});const e=t.getAttribute("aria-controls");if(e){const t=document.getElementById(e);t&&(t.classList.add("is-active"),t.removeAttribute("hidden"),this.initializePanelIfNeeded(e));const a=Array.from(this.hashToPanelMap.entries()).find(([t,a])=>a===e)?.[0];a&&history.replaceState(null,"",`#${a}`)}}handleKeyDown(t,e){const a=this.tabs.indexOf(e);let i=null;switch(t.key){case"ArrowLeft":i=a>0?a-1:this.tabs.length-1,t.preventDefault();break;case"ArrowRight":i=a<this.tabs.length-1?a+1:0,t.preventDefault();break;case"Home":i=0,t.preventDefault();break;case"End":i=this.tabs.length-1,t.preventDefault();break;case"Enter":case" ":this.switchToTab(e),t.preventDefault()}null!==i&&this.switchToTab(this.tabs[i])}initializePanelIfNeeded(t){if(this.initializedPanels.has(t))return;const e=this.initCallbacks.get(t);e&&(e(),this.initializedPanels.add(t))}}const e=[1e3,2e3,4e3];function a(t){return i(function(t){if(404===t)return"データファイルが見つかりません";if(403===t)return"データへのアクセスが拒否されました";if(500===t||502===t||503===t)return"サーバーエラーが発生しました";return"データの取得に失敗しました"}(t.status),"http",`status: ${t.status}, statusText: ${t.statusText}`,t.status)}function i(t,e,a,i){const n=new Error(t);return n.type=e,"number"==typeof i&&(n.status=i),a&&(n.detail=a),n}function n(t){return new Promise(e=>{window.setTimeout(e,t)})}const r={width:800,height:600,margin:{top:20,right:20,bottom:30,left:40}};async function o(t){try{const o=await async function(t,r={},o=1e4){let s;for(let c=0;c<=3;c+=1){const d=new AbortController,h=window.setTimeout(()=>d.abort(),o);try{const i=await fetch(t,{...r,signal:d.signal});if(window.clearTimeout(h),i.ok)return i;if(i.status>=500&&i.status<600&&c<3){s=a(i),await n(e[Math.min(c,e.length-1)]);continue}throw a(i)}catch(l){if(window.clearTimeout(h),l instanceof DOMException&&"AbortError"===l.name){s=i("データの取得がタイムアウトしました","timeout",l.message);break}if(l instanceof TypeError){if(s=i("データの取得に失敗しました","network",l.message),c<3){await n(e[Math.min(c,e.length-1)]);continue}break}s=i("データの取得に失敗しました","network",l instanceof Error?l.message:String(l));break}}throw s??i("データの取得に失敗しました","network")}(t);try{return await o.json()}catch(r){throw i("データの形式が不正です","parse",r instanceof Error?r.message:String(r))}}catch(o){throw console.error("可視化データの読み込みに失敗しました:",o),o}}function s(t,e=r){d3.select(t).select("svg").remove();const a=e.width+e.margin.left+e.margin.right,i=e.height+e.margin.top+e.margin.bottom;return d3.select(t).append("svg").attr("viewBox",`0 0 ${a} ${i}`).attr("preserveAspectRatio","xMinYMin meet").attr("width","100%").style("max-width",`${a}px`).attr("class","visualization-svg")}function l(t,e=r){return t.append("g").attr("transform",`translate(${e.margin.left}, ${e.margin.top})`)}function c(t){return d3.select(t).select(".visualization-tooltip").remove(),d3.select(t).append("div").attr("class","visualization-tooltip").style("position","absolute").style("visibility","hidden").style("background-color","rgba(0, 0, 0, 0.8)").style("color","#fff").style("padding","8px 12px").style("border-radius","4px").style("font-size","12px").style("pointer-events","none").style("z-index","1000")}function d(t,e,a){t.html(e).style("visibility","visible").style("left",`${a.pageX+10}px`).style("top",a.pageY-20+"px")}function h(t){t.style("visibility","hidden")}function u(t,e){d3.select(t).append("div").attr("class","visualization-error").attr("role","alert").style("color","red").style("padding","20px").style("text-align","center").text(e)}const g={width:600,height:600,margin:{top:20,right:20,bottom:20,left:20},minRadius:20,maxRadius:150,padding:5};class m{constructor(t,e={}){this.svg=null,this.tooltip=null,this.zoom=null,this.container=t,this.config={...g,...e}}render(t){const e=this.transformData(t);this.svg=s(this.container,this.config),this.svg.attr("role","img").attr("aria-label","タグ別体験記録のサークルパッキング図。各円のサイズが体験回数を表しています。円をクリックまたはEnterキーで詳細を確認できます。マウスホイールまたはピンチでズーム可能です。").attr("aria-live","polite"),this.tooltip=c(this.container);const a=l(this.svg,this.config);this.zoom=d3.zoom().scaleExtent([.5,5]).on("zoom",t=>{a.attr("transform",t.transform)}),this.svg.call(this.zoom);const i=d3.pack().size([this.config.width,this.config.height]).padding(this.config.padding),n=d3.hierarchy(e).sum(t=>t.value||0).sort((t,e)=>(e.value||0)-(t.value||0));i(n);const r=this.getTagColorsFromDOM(),o=(u=t.tags.map(t=>t.tag),d3.scaleOrdinal().domain(u).range(d3.schemeCategory10));var u;const g=a.selectAll(".circle-node").data(n.descendants().filter(t=>1===t.depth)).enter().append("g").attr("class","circle-node").attr("transform",t=>`translate(${t.x},${t.y})`),m=g.append("circle").attr("r",t=>t.r||0).attr("fill",t=>{return e=t.data.name,r.get(e)||o(e);var e}).attr("opacity",.7).attr("stroke","#fff").attr("stroke-width",2).attr("tabindex",0).attr("aria-label",t=>`${t.data.name} ${t.value??0}件`);g.append("text").attr("text-anchor","middle").attr("dominant-baseline","middle").attr("font-size",t=>`${Math.min((t.r||0)/3,18)}px`).attr("font-weight","bold").attr("fill","#fff").attr("pointer-events","none").text(t=>t.data.name),g.append("text").attr("text-anchor","middle").attr("dominant-baseline","middle").attr("dy",t=>`${Math.min((t.r||0)/3,18)+5}px`).attr("font-size",t=>`${Math.min((t.r||0)/4,14)}px`).attr("fill","#fff").attr("pointer-events","none").text(t=>`${t.value}件`),m.on("mouseover",(t,e)=>{d3.select(t.currentTarget).attr("opacity",1).attr("stroke-width",3);const a=`${e.data.name}<br/>体験記録: ${e.value}件`;this.tooltip&&d(this.tooltip,a,t)}).on("mousemove",(t,e)=>{const a=`${e.data.name}<br/>体験記録: ${e.value}件`;this.tooltip&&d(this.tooltip,a,t)}).on("mouseout",t=>{d3.select(t.currentTarget).attr("opacity",.7).attr("stroke-width",2),this.tooltip&&h(this.tooltip)}).on("click",(t,e)=>{const a=document.getElementById("toggle-tag-filter"),i=document.querySelector(".tag-filter");"none"!==i?.style.display&&i?.style.display||a?.click();const n=document.getElementById("clear-selection");document.querySelectorAll(".tag-filter-btn.active").length>0&&n?.click();const r=document.querySelector(`.tag-filter-btn[data-tag="${e.data.name}"]`);r?.click();const o=document.querySelector('[aria-controls="panel-list"]');o?.click()}).on("focus",t=>{d3.select(t.currentTarget).attr("opacity",1).attr("stroke-width",4)}).on("blur",t=>{d3.select(t.currentTarget).attr("opacity",.7).attr("stroke-width",2),this.tooltip&&h(this.tooltip)}).on("keydown",(t,e)=>{if("Enter"!==t.key&&" "!==t.key&&"Spacebar"!==t.key)return;t.preventDefault();const a=t.currentTarget,{x:i,y:n,width:r,height:o}=a.getBoundingClientRect(),s=i+r/2,l=n+o/2,c=new MouseEvent("keydown",{clientX:s,clientY:l,pageX:s+window.scrollX,pageY:l+window.scrollY}),h=`${e.data.name}<br/>体験記録: ${e.value}件`;this.tooltip&&d(this.tooltip,h,c),d3.select(a).attr("opacity",1).attr("stroke-width",4)}),this.addZoomResetButton()}transformData(t){return{name:"root",children:t.tags.map(t=>({name:t.tag,value:t.count}))}}getTagColorsFromDOM(){const t=new Map;return document.querySelectorAll(".tag-filter-btn").forEach(e=>{const a=e.getAttribute("data-tag"),i=(e.getAttribute("style")||"").match(/--tag-color:\s*([^;]+)/),n=i?i[1].trim():null;a&&n&&t.set(a,n)}),t}addZoomResetButton(){if(!this.svg)return;const t=d3.select(this.container).append("button").attr("class","zoom-reset-button").attr("aria-label","ズームをリセット").style("position","absolute").style("top","10px").style("right","10px").style("padding","8px 16px").style("background-color","#007bff").style("color","#fff").style("border","none").style("border-radius","4px").style("cursor","pointer").style("font-size","14px").style("z-index","1000").text("ズームリセット");t.on("click",()=>{this.svg&&this.zoom&&this.svg.transition().duration(750).call(this.zoom.transform,d3.zoomIdentity)}),t.on("mouseover",function(){d3.select(this).style("background-color","#0056b3")}),t.on("mouseout",function(){d3.select(this).style("background-color","#007bff")})}clear(){this.svg&&(this.svg.remove(),this.svg=null),this.tooltip&&(this.tooltip.remove(),this.tooltip=null),d3.select(this.container).select(".zoom-reset-button").remove()}setZoomEnabled(t){this.svg&&this.zoom&&(t?this.svg.call(this.zoom):this.svg.on(".zoom",null))}}const p={width:800,height:150,margin:{top:20,right:20,bottom:20,left:60},cellSize:15,cellPadding:2,colorRange:["#ebedf0","#216e39"]};class f{constructor(t,e={}){this.svg=null,this.tooltip=null,this.allYearData=[],this.yearSelectorHandler=null,this.container=t,this.config={...p,...e}}render(t){if(Array.isArray(t)){if(this.allYearData=t,0===t.length)return;this.setupYearSelector();const e=Math.max(...t.map(t=>t.year));return void this.renderForYear(e)}this.renderSingleData(t)}renderSingleData(t,e){const a=this.transformData(t.daily,e);if(a.length>0){const t=((d3.max(a,t=>t.weekIndex)||0)+1)*(this.config.cellSize+this.config.cellPadding),e=Math.max(this.config.width,t);this.config={...this.config,width:e}}this.svg=s(this.container,this.config),this.tooltip=c(this.container),this.svg.attr("role","img").attr("aria-label","体験記録のタイムラインヒートマップ。日別の体験回数を色の濃淡で表示しています。各セルをクリックまたはEnterキーで詳細を確認できます。").attr("aria-live","polite");const i=l(this.svg,this.config),n=d3.max(a,t=>t.count)||1,r=d3.scaleLinear().domain([0,n]).range(this.config.colorRange),o=d3.scaleQuantize().domain([0,n]).range([1,2,3,4]),u=d3.timeFormat("%Y年%-m月%-d日"),g=t=>`${u(t.date)}<br/>体験記録: ${t.count}件`,m=t=>o(t);Array.from(new Set(a.map(t=>t.weekIndex)));i.selectAll(".weekday-label").data(["日","月","火","水","木","金","土"]).enter().append("text").attr("class","weekday-label").attr("x",-10).attr("y",(t,e)=>e*(this.config.cellSize+this.config.cellPadding)+12).attr("text-anchor","end").attr("font-size","10px").attr("fill","#666").text(t=>t);i.selectAll(".heatmap-cell").data(a).enter().append("rect").attr("class","heatmap-cell").attr("x",t=>t.weekIndex*(this.config.cellSize+this.config.cellPadding)).attr("y",t=>t.weekday*(this.config.cellSize+this.config.cellPadding)).attr("width",this.config.cellSize).attr("height",this.config.cellSize).attr("rx",2).attr("ry",2).attr("fill",t=>0===t.count?"#ebedf0":r(t.count)).attr("stroke","#fff").attr("stroke-width",t=>m(t.count)).attr("tabindex",0).attr("aria-label",t=>`${u(t.date)} 体験記録${t.count}件`).on("click",(t,e)=>{const a=d3.timeFormat("%Y-%m-%d")(e.date),i=new CustomEvent("heatmap-cell-click",{detail:{date:a},bubbles:!0});document.dispatchEvent(i)}).on("mouseover",(t,e)=>{const a=m(e.count);d3.select(t.currentTarget).attr("stroke","#000").attr("stroke-width",Math.max(a,2));const i=g(e);this.tooltip&&d(this.tooltip,i,t)}).on("mousemove",(t,e)=>{const a=g(e);this.tooltip&&d(this.tooltip,a,t)}).on("mouseout",(t,e)=>{const a=m(e.count);d3.select(t.currentTarget).attr("stroke","#fff").attr("stroke-width",a),this.tooltip&&h(this.tooltip)}).on("focus",(t,e)=>{const a=m(e.count);d3.select(t.currentTarget).attr("stroke","#000").attr("stroke-width",Math.max(a,3))}).on("blur",(t,e)=>{const a=m(e.count);d3.select(t.currentTarget).attr("stroke","#fff").attr("stroke-width",a),this.tooltip&&h(this.tooltip)}).on("keydown",(t,e)=>{if("Enter"===t.key||" "===t.key||"Spacebar"===t.key){t.preventDefault();const a=t.currentTarget.getBoundingClientRect(),i={pageX:window.scrollX+a.x+a.width/2,pageY:window.scrollY+a.y+a.height/2},n=g(e);this.tooltip&&d(this.tooltip,n,i)}}),this.addLegend(i,r,n)}transformData(t,e){const a=t.sort((t,e)=>new Date(t.date).getTime()-new Date(e.date).getTime());if(0===a.length&&void 0===e)return[];let i,n;if(void 0!==e){const t=new Date(e,0,1),a=new Date(e,11,31);i=new Date(t),i.setDate(i.getDate()-i.getDay()),n=new Date(a),n.setDate(n.getDate()+(6-n.getDay()))}else{if(0===a.length)return[];const t=new Date(a[0].date),e=new Date(a[a.length-1].date);i=new Date(t),i.setDate(i.getDate()-i.getDay()),n=new Date(e),n.setDate(n.getDate()+(6-n.getDay()))}const r=new Map;for(const c of a){const t=r.get(c.date)||0;r.set(c.date,t+c.count)}const o=[];let s=0;const l=new Date(i);for(;l<=n;){const t=d3.timeFormat("%Y-%m-%d")(l),e=r.get(t)||0,a=l.getDay();o.push({date:new Date(l),count:e,weekday:a,weekIndex:s}),l.setDate(l.getDate()+1),0===l.getDay()&&s++}return o}addLegend(t,e,a){const i=[{label:"少",value:0},{label:"",value:.25*a},{label:"",value:.5*a},{label:"",value:.75*a},{label:"多",value:a}],n=t.append("g").attr("class","legend").attr("transform",`translate(0, ${7*(this.config.cellSize+this.config.cellPadding)+10})`);n.append("text").attr("x",0).attr("y",0).attr("font-size","10px").attr("fill","#666").text("体験頻度:");const r=n.selectAll(".legend-item").data(i).enter().append("g").attr("class","legend-item").attr("transform",(t,e)=>`translate(${70+e*(this.config.cellSize+this.config.cellPadding+5)}, -10)`);r.append("rect").attr("width",this.config.cellSize).attr("height",this.config.cellSize).attr("rx",2).attr("ry",2).attr("fill",t=>0===t.value?"#ebedf0":e(t.value)),r.append("text").attr("x",this.config.cellSize/2).attr("y",this.config.cellSize+12).attr("text-anchor","middle").attr("font-size","9px").attr("fill","#666").text(t=>t.label)}setupYearSelector(){const t=document.getElementById("timeline-year-select");if(!t)return;this.yearSelectorHandler&&t.removeEventListener("change",this.yearSelectorHandler),t.innerHTML="";this.allYearData.map(t=>t.year).sort((t,e)=>e-t).forEach(e=>{const a=document.createElement("option");a.value=e.toString(),a.textContent=`${e}年`,t.appendChild(a)}),this.yearSelectorHandler=t=>{const e=parseInt(t.target.value,10);this.renderForYear(e)},t.addEventListener("change",this.yearSelectorHandler)}renderForYear(t){this.svg&&(this.svg.remove(),this.svg=null);const e=this.allYearData.find(e=>e.year===t);if(!e)return;const a=document.getElementById("timeline-year-select");a&&(a.value=t.toString()),this.renderSingleData({daily:e.daily},t)}clear(){this.svg&&(this.svg.remove(),this.svg=null),this.tooltip&&(this.tooltip.remove(),this.tooltip=null)}}const y="データの読み込みに失敗しました。ページをリロードしてください。";function b(t){if(function(t){return"object"==typeof t&&null!==t&&"string"==typeof t.type}(t))switch(t.type){case"network":return"ネットワーク接続を確認してください";case"timeout":return"通信がタイムアウトしました。再度お試しください";case"http":return`データの取得に失敗しました（エラーコード: ${t.status??"不明"}）`;case"parse":return"データの形式が不正です";default:return y}return t instanceof DOMException&&"AbortError"===t.name?"通信がタイムアウトしました。再度お試しください":y}function v(t,e){const a=document.querySelector(t);if(!a)return;a.innerHTML="";const i=document.createElement("div");i.className="visualization-placeholder",i.style.padding="20px",i.style.textAlign="center",i.textContent=e,a.appendChild(i)}async function w(){let e;try{e=await o("../data/disney-experience-visualization.json")}catch(i){console.error("可視化データの読み込みに失敗しました:",i);const t=b(i);return u("#timeline-heatmap",t),void u("#circle-packing",t)}const a=new t(".tabs");a.registerInitCallback("panel-timeline",()=>{try{const t={width:800,height:150,margin:{top:20,right:20,bottom:20,left:60},cellSize:15,cellPadding:2};if(e.yearlyTimeSeries&&e.yearlyTimeSeries.length>0){new f("#timeline-heatmap",t).render(e.yearlyTimeSeries)}else if(0===e.timeSeries.daily.length)v("#timeline-heatmap","データがありません。体験記録を追加してください。");else{new f("#timeline-heatmap",t).render(e.timeSeries)}}catch(i){console.error("タイムラインヒートマップの描画中にエラーが発生しました:",i),u("#timeline-heatmap",b(i))}}),a.registerInitCallback("panel-tags",()=>{try{if(0===e.tagStats.tags.length)v("#circle-packing","タグデータがありません。");else{new m("#circle-packing",{width:600,height:600,margin:{top:20,right:20,bottom:20,left:20}}).render(e.tagStats)}}catch(i){console.error("サークルパッキングの描画中にエラーが発生しました:",i),u("#circle-packing",b(i))}}),a.registerInitCallback("panel-list",()=>{}),a.registerInitCallback("panel-hotels",()=>{}),a.initialize(),document.querySelectorAll("[data-hotel-code]").forEach(t=>{t.addEventListener("click",()=>{const e=t.getAttribute("data-hotel-code");if(!e)return;const a=document.getElementById("toggle-tag-filter"),i=document.querySelector(".tag-filter");"none"!==i?.style.display&&i?.style.display||a?.click();const n=document.getElementById("clear-selection");document.querySelectorAll(".tag-filter-btn.active").length>0&&n?.click();const r=document.querySelector(`.tag-filter-btn[data-tag="${e}"]`);r?.click();const o=document.querySelector('[aria-controls="panel-list"]');o?.click()})}),document.addEventListener("heatmap-cell-click",t=>{const e=t.detail.date,a=document.querySelector('[aria-controls="panel-list"]');a?.click();const i=document.querySelector(`.log-entry[data-date="${e}"]`);i&&setTimeout(()=>{i.scrollIntoView({behavior:"smooth",block:"center"}),i.classList.add("highlighted"),setTimeout(()=>{i.classList.remove("highlighted")},2e3)},300)})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{w()}):w()}();
